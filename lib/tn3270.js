"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var net = require("net");
var Observable_1 = require("rxjs/Observable");
var chalk = require('chalk');
var Tn3270 = (function () {
    function Tn3270(host, port, model) {
        var _this = this;
        this.host = host;
        this.port = port;
        this.model = model;
        this.stream$ = Observable_1.Observable.create(function (observer) {
            _this.socket = new net.Socket();
            _this.socket.on('data', function (data) { return _this.dataHandler(data, observer); });
            _this.socket.on('error', function (error) {
                console.log(chalk.green('3270 -> HOST'), chalk.red(error.message));
                observer.error(error);
            });
            _this.socket.on('end', function () {
                console.log(chalk.green('3270 -> HOST'), chalk.cyan('Disconnected'));
                observer.complete();
            });
            _this.socket.setNoDelay(true);
            _this.socket.connect({ host: host, port: port }, function () {
                console.log(chalk.green('3270 -> HOST'), chalk.blue("Connected at " + host + ":" + port));
            });
            return function () { return _this.socket.end(); };
        });
    }
    Tn3270.prototype.write = function (bytes) {
        if (bytes instanceof Buffer)
            this.socket.write(bytes);
        else
            this.socket.write(Buffer.from(bytes));
    };
    Tn3270.prototype.dataHandler = function (data, observer) {
        if (data[0] === Telnet.IAC) {
            var negotiator = new Negotiator(data);
            var response = void 0;
            if (negotiator.matches(['IAC', 'DO', 'TERMINAL_TYPE']))
                response = ['IAC', 'WILL', 'TERMINAL_TYPE'];
            if (negotiator.matches(['IAC', 'DO', 'EOR']))
                response = ['IAC', 'WILL', 'EOR', 'IAC', 'DO', 'EOR'];
            if (negotiator.matches(['IAC', 'DO', 'BINARY']))
                response = ['IAC', 'WILL', 'BINARY', 'IAC', 'DO', 'BINARY'];
            if (negotiator.matches(['IAC', 'SB', 'TERMINAL_TYPE']))
                response = ['IAC', 'SB', 'TERMINAL_TYPE', '0x00', this.model, 'IAC', 'SE'];
            if (response) {
                console.log(chalk.yellow('HOST -> 3270'), chalk.white(negotiator.decode()));
                console.log(chalk.green('3270 -> HOST'), chalk.gray(response));
                this.write(negotiator.encode(response));
            }
        }
        else
            observer.next(data);
    };
    return Tn3270;
}());
exports.Tn3270 = Tn3270;
var Telnet;
(function (Telnet) {
    Telnet[Telnet["BINARY"] = 0] = "BINARY";
    Telnet[Telnet["DO"] = 253] = "DO";
    Telnet[Telnet["DONT"] = 254] = "DONT";
    Telnet[Telnet["EOR"] = 25] = "EOR";
    Telnet[Telnet["IAC"] = 255] = "IAC";
    Telnet[Telnet["SB"] = 250] = "SB";
    Telnet[Telnet["SE"] = 240] = "SE";
    Telnet[Telnet["TERMINAL_TYPE"] = 24] = "TERMINAL_TYPE";
    Telnet[Telnet["WILL"] = 251] = "WILL";
    Telnet[Telnet["WONT"] = 252] = "WONT";
})(Telnet || (Telnet = {}));
var Negotiator = (function () {
    function Negotiator(data) {
        this.data = data;
    }
    Negotiator.prototype.decode = function () {
        var commands = [];
        for (var ix = 0; ix < this.data.length; ix++) {
            var byte = this.data[ix];
            var decoded = Negotiator.reverse[String(byte)];
            if (typeof (decoded) === 'undefined')
                decoded = "0x" + ((byte < 16) ? '0' : '') + byte.toString(16);
            commands.push(decoded);
        }
        return commands;
    };
    Negotiator.prototype.encode = function (commands) {
        return commands.reduce(function (acc, command) {
            var encoded = Negotiator.lookup[command];
            if (typeof (command) === 'number')
                acc.push(command);
            else if (command.startsWith('0x'))
                acc.push(parseInt(command.substring(3), 16));
            else if (typeof (encoded) === 'undefined') {
                for (var ix = 0; ix < command.length; ix++)
                    acc.push(command.charCodeAt(ix));
            }
            else
                acc.push(encoded);
            return acc;
        }, []);
    };
    Negotiator.prototype.matches = function (commands) {
        var _this = this;
        return commands.every(function (command, ix) {
            return Negotiator.lookup[command] === _this.data[ix];
        });
    };
    Negotiator.lookup = {
        'BINARY': Telnet.BINARY,
        'DO': Telnet.DO,
        'DONT': Telnet.DONT,
        'EOR': Telnet.EOR,
        'IAC': Telnet.IAC,
        'SB': Telnet.SB,
        'SE': Telnet.SE,
        'TERMINAL_TYPE': Telnet.TERMINAL_TYPE,
        'WILL': Telnet.WILL,
        'WONT': Telnet.WONT
    };
    Negotiator.reverse = Object.keys(Negotiator.lookup)
        .reduce(function (acc, k) {
        acc[String(Negotiator.lookup[k])] = k;
        return acc;
    }, {});
    return Negotiator;
}());
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidG4zMjcwLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL3RuMzI3MC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLHlCQUEyQjtBQUUzQiw4Q0FBNkM7QUFHN0MsSUFBTSxLQUFLLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0FBVS9CO0lBT0UsZ0JBQW1CLElBQVksRUFDWixJQUFZLEVBQ1osS0FBYTtRQUZoQyxpQkFxQkM7UUFyQmtCLFNBQUksR0FBSixJQUFJLENBQVE7UUFDWixTQUFJLEdBQUosSUFBSSxDQUFRO1FBQ1osVUFBSyxHQUFMLEtBQUssQ0FBUTtRQUU5QixJQUFJLENBQUMsT0FBTyxHQUFHLHVCQUFVLENBQUMsTUFBTSxDQUFDLFVBQUMsUUFBMEI7WUFDMUQsS0FBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLEdBQUcsQ0FBQyxNQUFNLEVBQUUsQ0FBQztZQUMvQixLQUFJLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxNQUFNLEVBQUUsVUFBQyxJQUFZLElBQUssT0FBQSxLQUFJLENBQUMsV0FBVyxDQUFDLElBQUksRUFBRSxRQUFRLENBQUMsRUFBaEMsQ0FBZ0MsQ0FBQyxDQUFDO1lBQzNFLEtBQUksQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLE9BQU8sRUFBRSxVQUFDLEtBQVk7Z0JBQ25DLE9BQU8sQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxjQUFjLENBQUMsRUFBRSxLQUFLLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO2dCQUNuRSxRQUFRLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQ3hCLENBQUMsQ0FBQyxDQUFDO1lBQ0gsS0FBSSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsS0FBSyxFQUFFO2dCQUNwQixPQUFPLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsY0FBYyxDQUFDLEVBQUUsS0FBSyxDQUFDLElB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QUdELDRCQUFPLEdBQVAsVUFBUSxRQUFrQjtRQUExQixpQkFJQztRQUhDLE1BQU0sQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLFVBQUMsT0FBTyxFQUFFLEVBQUU7WUFDaEMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLEtBQUssS0FBSSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUN0RCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUE3RGMsaUJBQU0sR0FBRztRQUN0QixRQUFRLEVBQUUsTUFBTSxDQUFDLE1BQU07UUFDdkIsSUFBSSxFQUFFLE1BQU0sQ0FBQyxFQUFFO1FBQ2YsTUFBTSxFQUFFLE1BQU0sQ0FBQyxJQUFJO1FBQ25CLEtBQUssRUFBRSxNQUFNLENBQUMsR0FBRztRQUNqQixLQUFLLEVBQUUsTUFBTSxDQUFDLEdBQUc7UUFDakIsSUFBSSxFQUFFLE1BQU0sQ0FBQyxFQUFFO1FBQ2YsSUFBSSxFQUFFLE1BQU0sQ0FBQyxFQUFFO1FBQ2YsZUFBZSxFQUFFLE1BQU0sQ0FBQyxhQUFhO1FBQ3JDLE1BQU0sRUFBRSxNQUFNLENBQUMsSUFBSTtRQUNuQixNQUFNLEVBQUUsTUFBTSxDQUFDLElBQUk7S0FDcEIsQ0FBQztJQUVhLGtCQUFPLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDO1NBQ3BELE1BQU0sQ0FBQyxVQUFDLEdBQUcsRUFBRSxDQUFDO1FBQ2IsR0FBRyxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDdEMsTUFBTSxDQUFDLEdBQUcsQ0FBQztJQUNiLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQztJQThDWCxpQkFBQztDQUFBLEFBakVELElBaUVDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgbmV0IGZyb20gJ25ldCc7XG5cbmltcG9ydCB7IE9ic2VydmFibGUgfSBmcm9tICdyeGpzL09ic2VydmFibGUnO1xuaW1wb3J0IHsgT2JzZXJ2ZXIgfSBmcm9tICdyeGpzL09ic2VydmVyJztcblxuY29uc3QgY2hhbGsgPSByZXF1aXJlKCdjaGFsaycpO1xuXG4vKipcbiAqIFJhdyBUZWxuZXQgdG8gMzI3MFxuICpcbiAqIEBzZWUgaHR0cHM6Ly90b29scy5pZXRmLm9yZy9odG1sL3JmYzE1NzZcbiAqIEBzZWUgaHR0cHM6Ly90b29scy5pZXRmLm9yZy9odG1sL3JmYzE2NDdcbiAqIEBzZWUgaHR0cDovL3VzZXJzLmNzLmNmLmFjLnVrL0RhdmUuTWFyc2hhbGwvSW50ZXJuZXQvbm9kZTE0MS5odG1sXG4gKi9cblxuZXhwb3J0IGNsYXNzIFRuMzI3MCB7XG5cbiAgc3RyZWFtJDogT2JzZXJ2YWJsZTxCdWZmZXI+O1xuXG4gIHByaXZhdGUgc29ja2V0OiBuZXQuU29ja2V0O1xuXG4gIC8qKiBjdG9yICovXG4gIGNvbnN0cnVjdG9yKHB1YmxpYyBob3N0OiBzdHJpbmcsXG4gICAgICAgICAgICAgIHB1YmxpYyBwb3J0OiBudW1iZXIsXG4gICAgICAgICAgICAgIHB1YmxpYyBtb2RlbDogc3RyaW5nKSB7XG4gICAgLy8gYnVpbGQgb2JzZXJ2YWJsZSBzdHJlYW0gb3ZlciAzMjcwIGRhdGFcbiAgICB0aGlzLnN0cmVhbSQgPSBPYnNlcnZhYmxlLmNyZWF0ZSgob2JzZXJ2ZXI6IE9ic2VydmVyPEJ1ZmZlcj4pID0+IHtcbiAgICAgIHRoaXMuc29ja2V0ID0gbmV3IG5ldC5Tb2NrZXQoKTtcbiAgICAgIHRoaXMuc29ja2V0Lm9uKCdkYXRhJywgKGRhdGE6IEJ1ZmZlcikgPT4gdGhpcy5kYXRhSGFuZGxlcihkYXRhLCBvYnNlcnZlcikpO1xuICAgICAgdGhpcy5zb2NrZXQub24oJ2Vycm9yJywgKGVycm9yOiBFcnJvcikgPT4ge1xuICAgICAgICBjb25zb2xlLmxvZyhjaGFsay5ncmVlbignMzI3MCAtPiBIT1NUJyksIGNoYWxrLnJlZChlcnJvci5tZXNzYWdlKSk7XG4gICAgICAgIG9ic2VydmVyLmVycm9yKGVycm9yKTtcbiAgICAgIH0pO1xuICAgICAgdGhpcy5zb2NrZXQub24oJ2VuZCcsICgpID0+IHtcbiAgICAgICAgY29uc29sZS5sb2coY2hhbGsuZ3JlZW4oJzMyNzAgLT4gSE9TVCcpLCBjaGFsay5jeWFuKCdEaXNjb25uZWN0ZWQnKSk7XG4gICAgICAgIG9ic2VydmVyLmNvbXBsZXRlKCk7XG4gICAgICB9KTtcbiAgICAgIHRoaXMuc29ja2V0LnNldE5vRGVsYXkodHJ1ZSk7XG4gICAgICB0aGlzLnNvY2tldC5jb25uZWN0KHtob3N0LCBwb3J0fSwgKCkgPT4ge1xuICAgICAgICBjb25zb2xlLmxvZyhjaGFsay5ncmVlbignMzI3MCAtPiBIT1NUJyksIGNoYWxrLmJsdWUoYENvbm5lY3RlZCBhdCAke2hvc3R9OiR7cG9ydH1gKSk7XG4gICAgICB9KTtcbiAgICAgIHJldHVybiAoKSA9PiB0aGlzLnNvY2tldC5lbmQoKTtcbiAgICB9KTtcbiAgfVxuXG4gIC8qKiBXcml0ZSByYXcgYnl0ZXMgdG8gMzI3MCAqL1xuICB3cml0ZShieXRlczogYW55KTogdm9pZCB7XG4gICAgaWYgKGJ5dGVzIGluc3RhbmNlb2YgQnVmZmVyKVxuICAgICAgdGhpcy5zb2NrZXQud3JpdGUoYnl0ZXMpO1xuICAgIGVsc2UgdGhpcy5zb2NrZXQud3JpdGUoQnVmZmVyLmZyb20oYnl0ZXMpKTtcbiAgfVxuXG4gIC8vIHByaXZhdGUgbWV0aG9kc1xuXG4gIHByaXZhdGUgZGF0YUhhbmRsZXIoZGF0YTogQnVmZmVyLFxuICAgICAgICAgICAgICAgICAgICAgIG9ic2VydmVyOiBPYnNlcnZlcjxCdWZmZXI+KTogdm9pZCB7XG4gICAgaWYgKGRhdGFbMF0gPT09IFRlbG5ldC5JQUMpIHtcbiAgICAgIGNvbnN0IG5lZ290aWF0b3IgPSBuZXcgTmVnb3RpYXRvcihkYXRhKTtcbiAgICAgIGxldCByZXNwb25zZTtcbiAgICAgIGlmIChuZWdvdGlhdG9yLm1hdGNoZXMoWydJQUMnLCAnRE8nLCAnVEVSTUlOQUxfVFlQRSddKSlcbiAgICAgICAgcmVzcG9uc2UgPSBbJ0lBQycsICdXSUxMJywgJ1RFUk1JTkFMX1RZUEUnXTtcbiAgICAgIGlmIChuZWdvdGlhdG9yLm1hdGNoZXMoWydJQUMnLCAnRE8nLCAnRU9SJ10pKVxuICAgICAgICByZXNwb25zZSA9IFsnSUFDJywgJ1dJTEwnLCAnRU9SJywgJ0lBQycsICdETycsICdFT1InXTtcbiAgICAgIGlmIChuZWdvdGlhdG9yLm1hdGNoZXMoWydJQUMnLCAnRE8nLCAnQklOQVJZJ10pKVxuICAgICAgICByZXNwb25zZSA9IFsnSUFDJywgJ1dJTEwnLCAnQklOQVJZJywgJ0lBQycsICdETycsICdCSU5BUlknXTtcbiAgICAgIGlmIChuZWdvdGlhdG9yLm1hdGNoZXMoWydJQUMnLCAnU0InLCAnVEVSTUlOQUxfVFlQRSddKSlcbiAgICAgICAgcmVzcG9uc2UgPSBbJ0lBQycsICdTQicsICdURVJNSU5BTF9UWVBFJywgJzB4MDAnLCB0aGlzLm1vZGVsLCAnSUFDJywgJ1NFJ107XG4gICAgICAvLyBzZW5kIHJlc3BvbnNlXG4gICAgICBpZiAocmVzcG9uc2UpIHtcbiAgICAgICAgY29uc29sZS5sb2coY2hhbGsueWVsbG93KCdIT1NUIC0+IDMyNzAnKSwgY2hhbGsud2hpdGUobmVnb3RpYXRvci5kZWNvZGUoKSkpO1xuICAgICAgICBjb25zb2xlLmxvZyhjaGFsay5ncmVlbignMzI3MCAtPiBIT1NUJyksIGNoYWxrLmdyYXkocmVzcG9uc2UpKTtcbiAgICAgICAgdGhpcy53cml0ZShuZWdvdGlhdG9yLmVuY29kZShyZXNwb25zZSkpO1xuICAgICAgfVxuICAgIH1cbiAgICBlbHNlIG9ic2VydmVyLm5leHQoZGF0YSk7XG4gIH1cblxufVxuXG4vKipcbiAqIE5lZ290aWF0ZSBUZWxuZXQgY29ubmVjdGlvbiAzMjcwIDwtPiBIb3N0XG4gKi9cblxuZW51bSBUZWxuZXQge1xuICBCSU5BUlkgICAgICAgID0gMCxcbiAgRE8gICAgICAgICAgICA9IDI1MyxcbiAgRE9OVCAgICAgICAgICA9IDI1NCxcbiAgRU9SICAgICAgICAgICA9IDI1LFxuICBJQUMgICAgICAgICAgID0gMjU1LFxuICBTQiAgICAgICAgICAgID0gMjUwLFxuICBTRSAgICAgICAgICAgID0gMjQwLFxuICBURVJNSU5BTF9UWVBFID0gMjQsXG4gIFdJTEwgICAgICAgICAgPSAyNTEsXG4gIFdPTlQgICAgICAgICAgPSAyNTJcbn1cblxuY2xhc3MgTmVnb3RpYXRvciB7XG5cbiAgcHJpdmF0ZSBzdGF0aWMgbG9va3VwID0ge1xuICAgICdCSU5BUlknOiBUZWxuZXQuQklOQVJZLFxuICAgICdETyc6IFRlbG5ldC5ETyxcbiAgICAnRE9OVCc6IFRlbG5ldC5ET05ULFxuICAgICdFT1InOiBUZWxuZXQuRU9SLFxuICAgICdJQUMnOiBUZWxuZXQuSUFDLFxuICAgICdTQic6IFRlbG5ldC5TQixcbiAgICAnU0UnOiBUZWxuZXQuU0UsXG4gICAgJ1RFUk1JTkFMX1RZUEUnOiBUZWxuZXQuVEVSTUlOQUxfVFlQRSxcbiAgICAnV0lMTCc6IFRlbG5ldC5XSUxMLFxuICAgICdXT05UJzogVGVsbmV0LldPTlRcbiAgfTtcblxuICBwcml2YXRlIHN0YXRpYyByZXZlcnNlID0gT2JqZWN0LmtleXMoTmVnb3RpYXRvci5sb29rdXApXG4gICAgLnJlZHVjZSgoYWNjLCBrKSA9PiB7XG4gICAgICBhY2NbU3RyaW5nKE5lZ290aWF0b3IubG9va3VwW2tdKV0gPSBrO1xuICAgICAgcmV0dXJuIGFjYztcbiAgICB9LCB7fSk7XG5cbiAgLyoqIGN0b3IgKi9cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBkYXRhOiBCdWZmZXIpIHsgfVxuXG4gIC8qKiBEZWNvZGUgSUFDIGNvbW1hbmQgKi9cbiAgZGVjb2RlKCk6IHN0cmluZ1tdIHtcbiAgICBjb25zdCBjb21tYW5kczogc3RyaW5nW10gPSBbXTtcbiAgICBmb3IgKGxldCBpeCA9IDA7IGl4IDwgdGhpcy5kYXRhLmxlbmd0aDsgaXgrKykge1xuICAgICAgY29uc3QgYnl0ZSA9IHRoaXMuZGF0YVtpeF07XG4gICAgICBsZXQgZGVjb2RlZCA9IE5lZ290aWF0b3IucmV2ZXJzZVtTdHJpbmcoYnl0ZSldO1xuICAgICAgLy8gZGVjb2RlIGFueXRoaW5nIG5vdCBpbiBsb29rdXAgYXMgMHhYWFxuICAgICAgaWYgKHR5cGVvZihkZWNvZGVkKSA9PT0gJ3VuZGVmaW5lZCcpXG4gICAgICAgIGRlY29kZWQgPSBgMHgkeyhieXRlIDwgMTYpPyAnMCcgOiAnJ30ke2J5dGUudG9TdHJpbmcoMTYpfWA7XG4gICAgICBjb21tYW5kcy5wdXNoKGRlY29kZWQpO1xuICAgIH1cbiAgICByZXR1cm4gY29tbWFuZHM7XG4gIH1cblxuICAvKiogRW5jb2RlIElBQyByZXNwb25zZSAqL1xuICBlbmNvZGUoY29tbWFuZHM6IHN0cmluZ1tdKTogbnVtYmVyW10ge1xuICAgIHJldHVybiBjb21tYW5kcy5yZWR1Y2UoKGFjYywgY29tbWFuZCkgPT4ge1xuICAgICAgY29uc3QgZW5jb2RlZCA9IE5lZ290aWF0b3IubG9va3VwW2NvbW1hbmRdO1xuICAgICAgLy8gbGVhdmUgcmF3IG51bWJlcnMgYXMgaXNcbiAgICAgIGlmICh0eXBlb2YoY29tbWFuZCkgPT09ICdudW1iZXInKVxuICAgICAgICBhY2MucHVzaChjb21tYW5kKTtcbiAgICAgIC8vIGNvbnZlcnQgaGV4IHN0cmluZ3MgdG8gZGVjaW1hbFxuICAgICAgZWxzZSBpZiAoY29tbWFuZC5zdGFydHNXaXRoKCcweCcpKVxuICAgICAgICBhY2MucHVzaChwYXJzZUludChjb21tYW5kLnN1YnN0cmluZygzKSwgMTYpKTtcbiAgICAgIC8vIGFueXRoaW5nIG5vdCBpbiBsb29rdXAgaXMgYSBzdHJpbmcsIHNvIGRlY29kZSBieXRlc1xuICAgICAgZWxzZSBpZiAodHlwZW9mKGVuY29kZWQpID09PSAndW5kZWZpbmVkJykge1xuICAgICAgICBmb3IgKGxldCBpeCA9IDA7IGl4IDwgY29tbWFuZC5sZW5ndGg7IGl4KyspXG4gICAgICAgICAgYWNjLnB1c2goY29tbWFuZC5jaGFyQ29kZUF0KGl4KSk7XG4gICAgICB9XG4gICAgICBlbHNlIGFjYy5wdXNoKGVuY29kZWQpO1xuICAgICAgcmV0dXJuIGFjYztcbiAgICB9LCBbXSBhcyBhbnkpO1xuICB9XG5cbiAgLyoqIFdoaWNoIElBQyBjb21tYW5kIHNlcXVlbmNlPyAqL1xuICBtYXRjaGVzKGNvbW1hbmRzOiBzdHJpbmdbXSk6IGJvb2xlYW4ge1xuICAgIHJldHVybiBjb21tYW5kcy5ldmVyeSgoY29tbWFuZCwgaXgpID0+ICB7XG4gICAgICByZXR1cm4gTmVnb3RpYXRvci5sb29rdXBbY29tbWFuZF0gPT09IHRoaXMuZGF0YVtpeF07XG4gICAgfSk7XG4gIH1cblxufVxuIl19