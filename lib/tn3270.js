"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var net = require("net");
var data_stream_1 = require("./data-stream");
var Observable_1 = require("rxjs/Observable");
var chalk = require('chalk');
var Tn3270 = (function () {
    function Tn3270(host, port, model) {
        var _this = this;
        this.host = host;
        this.port = port;
        this.model = model;
        this.stream$ = Observable_1.Observable.create(function (observer) {
            _this.socket = new net.Socket();
            _this.socket.on('data', function (data) { return _this.dataHandler(data, observer); });
            _this.socket.on('error', function (error) {
                console.log(chalk.green('3270 -> HOST'), chalk.red(error.message));
                observer.error(error);
            });
            _this.socket.on('end', function () {
                console.log(chalk.green('3270 -> HOST'), chalk.cyan('Disconnected'));
                observer.complete();
            });
            _this.socket.setNoDelay(true);
            _this.socket.connect({ host: host, port: port }, function () {
                console.log(chalk.green('3270 -> HOST'), chalk.blue("Connected at " + host + ":" + port));
            });
            return function () { return _this.socket.end(); };
        });
    }
    Tn3270.prototype.write = function (bytes) {
        if (bytes instanceof Buffer)
            this.socket.write(bytes);
        else
            this.socket.write(Buffer.from(bytes));
    };
    Tn3270.prototype.dataHandler = function (data, observer) {
        if (data[0] === data_stream_1.Telnet.IAC) {
            var negotiator = new Negotiator(data);
            var response = void 0;
            if (negotiator.matches(['IAC', 'DO', 'TERMINAL_TYPE']))
                response = ['IAC', 'WILL', 'TERMINAL_TYPE'];
            if (negotiator.matches(['IAC', 'DO', 'EOR']))
                response = ['IAC', 'WILL', 'EOR', 'IAC', 'DO', 'EOR'];
            if (negotiator.matches(['IAC', 'DO', 'BINARY']))
                response = ['IAC', 'WILL', 'BINARY', 'IAC', 'DO', 'BINARY'];
            if (negotiator.matches(['IAC', 'SB', 'TERMINAL_TYPE']))
                response = ['IAC', 'SB', 'TERMINAL_TYPE', '0x00', this.model, 'IAC', 'SE'];
            if (response) {
                console.log(chalk.yellow('HOST -> 3270'), chalk.white(negotiator.decode()));
                console.log(chalk.green('3270 -> HOST'), chalk.gray(response));
                this.write(negotiator.encode(response));
            }
        }
        else
            observer.next(data);
    };
    return Tn3270;
}());
exports.Tn3270 = Tn3270;
var Negotiator = (function () {
    function Negotiator(data) {
        this.data = data;
    }
    Negotiator.prototype.decode = function () {
        var commands = [];
        for (var ix = 0; ix < this.data.length; ix++) {
            var byte = this.data[ix];
            var decoded = Negotiator.reverse[String(byte)];
            if (typeof (decoded) === 'undefined')
                decoded = "0x" + ((byte < 16) ? '0' : '') + byte.toString(16);
            commands.push(decoded);
        }
        return commands;
    };
    Negotiator.prototype.encode = function (commands) {
        return commands.reduce(function (acc, command) {
            var encoded = Negotiator.lookup[command];
            if (typeof (command) === 'number')
                acc.push(command);
            else if (command.startsWith('0x'))
                acc.push(parseInt(command.substring(3), 16));
            else if (typeof (encoded) === 'undefined') {
                for (var ix = 0; ix < command.length; ix++)
                    acc.push(command.charCodeAt(ix));
            }
            else
                acc.push(encoded);
            return acc;
        }, []);
    };
    Negotiator.prototype.matches = function (commands) {
        var _this = this;
        return commands.every(function (command, ix) {
            return Negotiator.lookup[command] === _this.data[ix];
        });
    };
    Negotiator.lookup = {
        'BINARY': data_stream_1.Telnet.BINARY,
        'DO': data_stream_1.Telnet.DO,
        'DONT': data_stream_1.Telnet.DONT,
        'EOR': data_stream_1.Telnet.EOR,
        'IAC': data_stream_1.Telnet.IAC,
        'SB': data_stream_1.Telnet.SB,
        'SE': data_stream_1.Telnet.SE,
        'TERMINAL_TYPE': data_stream_1.Telnet.TERMINAL_TYPE,
        'WILL': data_stream_1.Telnet.WILL,
        'WONT': data_stream_1.Telnet.WONT
    };
    Negotiator.reverse = data_stream_1.reverseMap(Negotiator.lookup);
    return Negotiator;
}());
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidG4zMjcwLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL3RuMzI3MC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLHlCQUEyQjtBQUUzQiw2Q0FBbUQ7QUFFbkQsOENBQTZDO0FBRzdDLElBQU0sS0FBSyxHQUFHLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQztBQVUvQjtJQU9FLGdCQUFtQixJQUFZLEVBQ1osSUFBWSxFQUNaLEtBQWE7UUFGaEMsaUJBcUJDO1FBckJrQixTQUFJLEdBQUosSUFBSSxDQUFRO1FBQ1osU0FBSSxHQUFKLElBQUksQ0FBUTtRQUNaLFVBQUssR0FBTCxLQUFLLENBQVE7UUFFOUIsSUFBSSxDQUFDLE9BQU8sR0FBRyx1QkFBVSxDQUFDLE1BQU0sQ0FBQyxVQUFDLFFBQTBCO1lBQzFELEtBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxHQUFHLENBQUMsTUFBTSxFQUFFLENBQUM7WUFDL0IsS0FBSSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsTUFBTSxFQUFFLFVBQUMsSUFBWSxJQUFLLE9BQUEsS0FBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLEVBQUUsUUFBUSxDQUFDLEVBQWhDLENBQWdDLENBQUMsQ0FBQztZQUMzRSxLQUFJLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxPQUFPLEVBQUUsVUFBQyxLQUFZO2dCQUNuQyxPQUFPLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsY0FBYyxDQUFDLEVBQUUsS0FBSyxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztnQkFDbkUsUUFBUSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUN4QixDQUFDLENBQUMsQ0FBQztZQUNILEtBQUksQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLEtBQUssRUFBRTtnQkFDcEIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLGNBQWMsQ0FBQyxFQUFF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QixRQUFRLEVBQUUsb0JBQU0sQ0FBQyxNQUFNO1FBQ3ZCLElBQUksRUFBRSxvQkFBTSxDQUFDLEVBQUU7UUFDZixNQUFNLEVBQUUsb0JBQU0sQ0FBQyxJQUFJO1FBQ25CLEtBQUssRUFBRSxvQkFBTSxDQUFDLEdBQUc7UUFDakIsS0FBSyxFQUFFLG9CQUFNLENBQUMsR0FBRztRQUNqQixJQUFJLEVBQUUsb0JBQU0sQ0FBQyxFQUFFO1FBQ2YsSUFBSSxFQUFFLG9CQUFNLENBQUMsRUFBRTtRQUNmLGVBQWUsRUFBRSxvQkFBTSxDQUFDLGFBQWE7UUFDckMsTUFBTSxFQUFFLG9CQUFNLENBQUMsSUFBSTtRQUNuQixNQUFNLEVBQUUsb0JBQU0sQ0FBQyxJQUFJO0tBQ3BCLENBQUM7SUFFYSxrQkFBTyxHQUFHLHdCQUFVLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBOEN6RCxpQkFBQztDQUFBLEFBN0RELElBNkRDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgbmV0IGZyb20gJ25ldCc7XG5cbmltcG9ydCB7IFRlbG5ldCwgcmV2ZXJzZU1hcCB9IGZyb20gJy4vZGF0YS1zdHJlYW0nO1xuXG5pbXBvcnQgeyBPYnNlcnZhYmxlIH0gZnJvbSAncnhqcy9PYnNlcnZhYmxlJztcbmltcG9ydCB7IE9ic2VydmVyIH0gZnJvbSAncnhqcy9PYnNlcnZlcic7XG5cbmNvbnN0IGNoYWxrID0gcmVxdWlyZSgnY2hhbGsnKTtcblxuLyoqXG4gKiBSYXcgVGVsbmV0IHRvIDMyNzBcbiAqXG4gKiBAc2VlIGh0dHBzOi8vdG9vbHMuaWV0Zi5vcmcvaHRtbC9yZmMxNTc2XG4gKiBAc2VlIGh0dHBzOi8vdG9vbHMuaWV0Zi5vcmcvaHRtbC9yZmMxNjQ3XG4gKiBAc2VlIGh0dHA6Ly91c2Vycy5jcy5jZi5hYy51ay9EYXZlLk1hcnNoYWxsL0ludGVybmV0L25vZGUxNDEuaHRtbFxuICovXG5cbmV4cG9ydCBjbGFzcyBUbjMyNzAge1xuXG4gIHN0cmVhbSQ6IE9ic2VydmFibGU8QnVmZmVyPjtcblxuICBwcml2YXRlIHNvY2tldDogbmV0LlNvY2tldDtcblxuICAvKiogY3RvciAqL1xuICBjb25zdHJ1Y3RvcihwdWJsaWMgaG9zdDogc3RyaW5nLFxuICAgICAgICAgICAgICBwdWJsaWMgcG9ydDogbnVtYmVyLFxuICAgICAgICAgICAgICBwdWJsaWMgbW9kZWw6IHN0cmluZykge1xuICAgIC8vIGJ1aWxkIG9ic2VydmFibGUgc3RyZWFtIG92ZXIgMzI3MCBkYXRhXG4gICAgdGhpcy5zdHJlYW0kID0gT2JzZXJ2YWJsZS5jcmVhdGUoKG9ic2VydmVyOiBPYnNlcnZlcjxCdWZmZXI+KSA9PiB7XG4gICAgICB0aGlzLnNvY2tldCA9IG5ldyBuZXQuU29ja2V0KCk7XG4gICAgICB0aGlzLnNvY2tldC5vbignZGF0YScsIChkYXRhOiBCdWZmZXIpID0+IHRoaXMuZGF0YUhhbmRsZXIoZGF0YSwgb2JzZXJ2ZXIpKTtcbiAgICAgIHRoaXMuc29ja2V0Lm9uKCdlcnJvcicsIChlcnJvcjogRXJyb3IpID0+IHtcbiAgICAgICAgY29uc29sZS5sb2coY2hhbGsuZ3JlZW4oJzMyNzAgLT4gSE9TVCcpLCBjaGFsay5yZWQoZXJyb3IubWVzc2FnZSkpO1xuICAgICAgICBvYnNlcnZlci5lcnJvcihlcnJvcik7XG4gICAgICB9KTtcbiAgICAgIHRoaXMuc29ja2V0Lm9uKCdlbmQnLCAoKSA9PiB7XG4gICAgICAgIGNvbnNvbGUubG9nKGNoYWxrLmdyZWVuKCczMjcwIC0+IEhPU1QnKSwgY2hhbGsuY3lhbignRGlzY29ubmVjdGVkJykpO1xuICAgICAgICBvYnNlcnZlci5jb21wbGV0ZSgpO1xuICAgICAgfSk7XG4gICAgICB0aGlzLnNvY2tldC5zZXROb0RlbGF5KHRydWUpO1xuICAgICAgdGhpcy5zb2NrZXQuY29ubmVjdCh7aG9zdCwgcG9ydH0sICgpID0+IHtcbiAgICAgICAgY29uc29sZS5sb2coY2hhbGsuZ3JlZW4oJzMyNzAgLT4gSE9TVCcpLCBjaGFsay5ibHVlKGBDb25uZWN0ZWQgYXQgJHtob3N0fToke3BvcnR9YCkpO1xuICAgICAgfSk7XG4gICAgICByZXR1cm4gKCkgPT4gdGhpcy5zb2NrZXQuZW5kKCk7XG4gICAgfSk7XG4gIH1cblxuICAvKiogV3JpdGUgcmF3IGJ5dGVzIHRvIDMyNzAgKi9cbiAgd3JpdGUoYnl0ZXM6IGFueSk6IHZvaWQge1xuICAgIGlmIChieXRlcyBpbnN0YW5jZW9mIEJ1ZmZlcilcbiAgICAgIHRoaXMuc29ja2V0LndyaXRlKGJ5dGVzKTtcbiAgICBlbHNlIHRoaXMuc29ja2V0LndyaXRlKEJ1ZmZlci5mcm9tKGJ5dGVzKSk7XG4gIH1cblxuICAvLyBwcml2YXRlIG1ldGhvZHNcblxuICBwcml2YXRlIGRhdGFIYW5kbGVyKGRhdGE6IEJ1ZmZlcixcbiAgICAgICAgICAgICAgICAgICAgICBvYnNlcnZlcjogT2JzZXJ2ZXI8QnVmZmVyPik6IHZvaWQge1xuICAgIGlmIChkYXRhWzBdID09PSBUZWxuZXQuSUFDKSB7XG4gICAgICBjb25zdCBuZWdvdGlhdG9yID0gbmV3IE5lZ290aWF0b3IoZGF0YSk7XG4gICAgICBsZXQgcmVzcG9uc2U7XG4gICAgICBpZiAobmVnb3RpYXRvci5tYXRjaGVzKFsnSUFDJywgJ0RPJywgJ1RFUk1JTkFMX1RZUEUnXSkpXG4gICAgICAgIHJlc3BvbnNlID0gWydJQUMnLCAnV0lMTCcsICdURVJNSU5BTF9UWVBFJ107XG4gICAgICBpZiAobmVnb3RpYXRvci5tYXRjaGVzKFsnSUFDJywgJ0RPJywgJ0VPUiddKSlcbiAgICAgICAgcmVzcG9uc2UgPSBbJ0lBQycsICdXSUxMJywgJ0VPUicsICdJQUMnLCAnRE8nLCAnRU9SJ107XG4gICAgICBpZiAobmVnb3RpYXRvci5tYXRjaGVzKFsnSUFDJywgJ0RPJywgJ0JJTkFSWSddKSlcbiAgICAgICAgcmVzcG9uc2UgPSBbJ0lBQycsICdXSUxMJywgJ0JJTkFSWScsICdJQUMnLCAnRE8nLCAnQklOQVJZJ107XG4gICAgICBpZiAobmVnb3RpYXRvci5tYXRjaGVzKFsnSUFDJywgJ1NCJywgJ1RFUk1JTkFMX1RZUEUnXSkpXG4gICAgICAgIHJlc3BvbnNlID0gWydJQUMnLCAnU0InLCAnVEVSTUlOQUxfVFlQRScsICcweDAwJywgdGhpcy5tb2RlbCwgJ0lBQycsICdTRSddO1xuICAgICAgLy8gc2VuZCByZXNwb25zZVxuICAgICAgaWYgKHJlc3BvbnNlKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKGNoYWxrLnllbGxvdygnSE9TVCAtPiAzMjcwJyksIGNoYWxrLndoaXRlKG5lZ290aWF0b3IuZGVjb2RlKCkpKTtcbiAgICAgICAgY29uc29sZS5sb2coY2hhbGsuZ3JlZW4oJzMyNzAgLT4gSE9TVCcpLCBjaGFsay5ncmF5KHJlc3BvbnNlKSk7XG4gICAgICAgIHRoaXMud3JpdGUobmVnb3RpYXRvci5lbmNvZGUocmVzcG9uc2UpKTtcbiAgICAgIH1cbiAgICB9XG4gICAgZWxzZSBvYnNlcnZlci5uZXh0KGRhdGEpO1xuICB9XG5cbn1cblxuLyoqXG4gKiBOZWdvdGlhdGUgVGVsbmV0IGNvbm5lY3Rpb24gMzI3MCA8LT4gSG9zdFxuICovXG5cbmNsYXNzIE5lZ290aWF0b3Ige1xuXG4gIHByaXZhdGUgc3RhdGljIGxvb2t1cCA9IHtcbiAgICAnQklOQVJZJzogVGVsbmV0LkJJTkFSWSxcbiAgICAnRE8nOiBUZWxuZXQuRE8sXG4gICAgJ0RPTlQnOiBUZWxuZXQuRE9OVCxcbiAgICAnRU9SJzogVGVsbmV0LkVPUixcbiAgICAnSUFDJzogVGVsbmV0LklBQyxcbiAgICAnU0InOiBUZWxuZXQuU0IsXG4gICAgJ1NFJzogVGVsbmV0LlNFLFxuICAgICdURVJNSU5BTF9UWVBFJzogVGVsbmV0LlRFUk1JTkFMX1RZUEUsXG4gICAgJ1dJTEwnOiBUZWxuZXQuV0lMTCxcbiAgICAnV09OVCc6IFRlbG5ldC5XT05UXG4gIH07XG5cbiAgcHJpdmF0ZSBzdGF0aWMgcmV2ZXJzZSA9IHJldmVyc2VNYXAoTmVnb3RpYXRvci5sb29rdXApO1xuXG4gIC8qKiBjdG9yICovXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgZGF0YTogQnVmZmVyKSB7IH1cblxuICAvKiogRGVjb2RlIElBQyBjb21tYW5kICovXG4gIGRlY29kZSgpOiBzdHJpbmdbXSB7XG4gICAgY29uc3QgY29tbWFuZHM6IHN0cmluZ1tdID0gW107XG4gICAgZm9yIChsZXQgaXggPSAwOyBpeCA8IHRoaXMuZGF0YS5sZW5ndGg7IGl4KyspIHtcbiAgICAgIGNvbnN0IGJ5dGUgPSB0aGlzLmRhdGFbaXhdO1xuICAgICAgbGV0IGRlY29kZWQgPSBOZWdvdGlhdG9yLnJldmVyc2VbU3RyaW5nKGJ5dGUpXTtcbiAgICAgIC8vIGRlY29kZSBhbnl0aGluZyBub3QgaW4gbG9va3VwIGFzIDB4WFhcbiAgICAgIGlmICh0eXBlb2YoZGVjb2RlZCkgPT09ICd1bmRlZmluZWQnKVxuICAgICAgICBkZWNvZGVkID0gYDB4JHsoYnl0ZSA8IDE2KT8gJzAnIDogJyd9JHtieXRlLnRvU3RyaW5nKDE2KX1gO1xuICAgICAgY29tbWFuZHMucHVzaChkZWNvZGVkKTtcbiAgICB9XG4gICAgcmV0dXJuIGNvbW1hbmRzO1xuICB9XG5cbiAgLyoqIEVuY29kZSBJQUMgcmVzcG9uc2UgKi9cbiAgZW5jb2RlKGNvbW1hbmRzOiBzdHJpbmdbXSk6IG51bWJlcltdIHtcbiAgICByZXR1cm4gY29tbWFuZHMucmVkdWNlKChhY2MsIGNvbW1hbmQpID0+IHtcbiAgICAgIGNvbnN0IGVuY29kZWQgPSBOZWdvdGlhdG9yLmxvb2t1cFtjb21tYW5kXTtcbiAgICAgIC8vIGxlYXZlIHJhdyBudW1iZXJzIGFzIGlzXG4gICAgICBpZiAodHlwZW9mKGNvbW1hbmQpID09PSAnbnVtYmVyJylcbiAgICAgICAgYWNjLnB1c2goY29tbWFuZCk7XG4gICAgICAvLyBjb252ZXJ0IGhleCBzdHJpbmdzIHRvIGRlY2ltYWxcbiAgICAgIGVsc2UgaWYgKGNvbW1hbmQuc3RhcnRzV2l0aCgnMHgnKSlcbiAgICAgICAgYWNjLnB1c2gocGFyc2VJbnQoY29tbWFuZC5zdWJzdHJpbmcoMyksIDE2KSk7XG4gICAgICAvLyBhbnl0aGluZyBub3QgaW4gbG9va3VwIGlzIGEgc3RyaW5nLCBzbyBkZWNvZGUgYnl0ZXNcbiAgICAgIGVsc2UgaWYgKHR5cGVvZihlbmNvZGVkKSA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgZm9yIChsZXQgaXggPSAwOyBpeCA8IGNvbW1hbmQubGVuZ3RoOyBpeCsrKVxuICAgICAgICAgIGFjYy5wdXNoKGNvbW1hbmQuY2hhckNvZGVBdChpeCkpO1xuICAgICAgfVxuICAgICAgZWxzZSBhY2MucHVzaChlbmNvZGVkKTtcbiAgICAgIHJldHVybiBhY2M7XG4gICAgfSwgW10gYXMgYW55KTtcbiAgfVxuXG4gIC8qKiBXaGljaCBJQUMgY29tbWFuZCBzZXF1ZW5jZT8gKi9cbiAgbWF0Y2hlcyhjb21tYW5kczogc3RyaW5nW10pOiBib29sZWFuIHtcbiAgICByZXR1cm4gY29tbWFuZHMuZXZlcnkoKGNvbW1hbmQsIGl4KSA9PiAge1xuICAgICAgcmV0dXJuIE5lZ290aWF0b3IubG9va3VwW2NvbW1hbmRdID09PSB0aGlzLmRhdGFbaXhdO1xuICAgIH0pO1xuICB9XG5cbn1cbiJdfQ==