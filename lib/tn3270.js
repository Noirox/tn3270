"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var net = require("net");
var data_stream_1 = require("./data-stream");
var Observable_1 = require("rxjs/Observable");
var chalk = require('chalk');
var Tn3270 = (function () {
    function Tn3270(host, port, model) {
        var _this = this;
        this.host = host;
        this.port = port;
        this.model = model;
        this.stream$ = Observable_1.Observable.create(function (observer) {
            _this.socket = new net.Socket();
            _this.socket.on('data', function (data) { return _this.dataHandler(data, observer); });
            _this.socket.on('error', function (error) { return observer.error(error); });
            _this.socket.on('end', function () { return observer.complete(); });
            _this.socket.setNoDelay(true);
            _this.socket.connect({ host: host, port: port }, function () {
                console.log(chalk.green('3270 -> HOST'), chalk.blue("Connected at " + host + ":" + port));
            });
            return function () { return _this.socket.destroy(); };
        });
    }
    Tn3270.prototype.write = function (bytes) {
        if (bytes instanceof Buffer)
            this.socket.write(bytes);
        else
            this.socket.write(Buffer.from(bytes));
    };
    Tn3270.prototype.dataHandler = function (data, observer) {
        if (data[0] === data_stream_1.Telnet.IAC) {
            var negotiator = new Negotiator(data);
            var response = void 0;
            if (negotiator.matches(['IAC', 'DO', 'TERMINAL_TYPE']))
                response = ['IAC', 'WILL', 'TERMINAL_TYPE'];
            if (negotiator.matches(['IAC', 'DO', 'EOR']))
                response = ['IAC', 'WILL', 'EOR', 'IAC', 'DO', 'EOR'];
            if (negotiator.matches(['IAC', 'DO', 'BINARY']))
                response = ['IAC', 'WILL', 'BINARY', 'IAC', 'DO', 'BINARY'];
            if (negotiator.matches(['IAC', 'SB', 'TERMINAL_TYPE']))
                response = ['IAC', 'SB', 'TERMINAL_TYPE', '0x00', this.model, 'IAC', 'SE'];
            if (response) {
                console.log(chalk.yellow('HOST -> 3270'), chalk.white(negotiator.decode()));
                console.log(chalk.green('3270 -> HOST'), chalk.gray(response));
                this.write(negotiator.encode(response));
            }
        }
        else
            observer.next(data);
    };
    return Tn3270;
}());
exports.Tn3270 = Tn3270;
var Negotiator = (function () {
    function Negotiator(data) {
        this.data = data;
    }
    Negotiator.prototype.decode = function () {
        var commands = [];
        for (var ix = 0; ix < this.data.length; ix++) {
            var byte = this.data[ix];
            var decoded = Negotiator.reverse[String(byte)];
            if (typeof (decoded) === 'undefined')
                decoded = "0x" + ((byte < 16) ? '0' : '') + byte.toString(16);
            commands.push(decoded);
        }
        return commands;
    };
    Negotiator.prototype.encode = function (commands) {
        return commands.reduce(function (acc, command) {
            var encoded = Negotiator.lookup[command];
            if (typeof (command) === 'number')
                acc.push(command);
            else if (command.startsWith('0x'))
                acc.push(parseInt(command.substring(3), 16));
            else if (typeof (encoded) === 'undefined') {
                for (var ix = 0; ix < command.length; ix++)
                    acc.push(command.charCodeAt(ix));
            }
            else
                acc.push(encoded);
            return acc;
        }, []);
    };
    Negotiator.prototype.matches = function (commands) {
        var _this = this;
        return commands.every(function (command, ix) {
            return Negotiator.lookup[command] === _this.data[ix];
        });
    };
    Negotiator.lookup = {
        'BINARY': data_stream_1.Telnet.BINARY,
        'DO': data_stream_1.Telnet.DO,
        'DONT': data_stream_1.Telnet.DONT,
        'EOR': data_stream_1.Telnet.EOR,
        'IAC': data_stream_1.Telnet.IAC,
        'SB': data_stream_1.Telnet.SB,
        'SE': data_stream_1.Telnet.SE,
        'TERMINAL_TYPE': data_stream_1.Telnet.TERMINAL_TYPE,
        'WILL': data_stream_1.Telnet.WILL,
        'WONT': data_stream_1.Telnet.WONT
    };
    Negotiator.reverse = data_stream_1.reverseMap(Negotiator.lookup);
    return Negotiator;
}());
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidG4zMjcwLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL3RuMzI3MC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLHlCQUEyQjtBQUUzQiw2Q0FBbUQ7QUFFbkQsOENBQTZDO0FBRzdDLElBQU0sS0FBSyxHQUFHLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQztBQVUvQjtJQU9FLGdCQUFtQixJQUFZLEVBQ1osSUFBWSxFQUNaLEtBQWE7UUFGaEMsaUJBZUM7UUFma0IsU0FBSSxHQUFKLElBQUksQ0FBUTtRQUNaLFNBQUksR0FBSixJQUFJLENBQVE7UUFDWixVQUFLLEdBQUwsS0FBSyxDQUFRO1FBRTlCLElBQUksQ0FBQyxPQUFPLEdBQUcsdUJBQVUsQ0FBQyxNQUFNLENBQUMsVUFBQyxRQUEwQjtZQUMxRCxLQUFJLENBQUMsTUFBTSxHQUFHLElBQUksR0FBRyxDQUFDLE1BQU0sRUFBRSxDQUFDO1lBQy9CLEtBQUksQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLE1BQU0sRUFBRSxVQUFDLElBQVksSUFBSyxPQUFBLEtBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxFQUFFLFFBQVEsQ0FBQyxFQUFoQyxDQUFnQyxDQUFDLENBQUM7WUFDM0UsS0FBSSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsT0FBTyxFQUFFLFVBQUMsS0FBWSxJQUFLLE9BQUEsUUFBUSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsRUFBckIsQ0FBcUIsQ0FBQyxDQUFDO1lBQ2pFLEtBQUksQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLEtBQUssRUFBRSxjQUFNLE9BQUEsUUFBUSxDQUFDLFFBQVEsRUFBRSxFQUFuQixDQUFtQixDQUFDLENBQUM7WUFDakQsS0FBSSxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDN0IsS0FBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsRUFBQyxJQUFJLE1BQUEsRUFBRSxJQUFJLE1BQUEsRUFBQyxF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RTtRQUNmLGVBQWUsRUFBRSxvQkFBTSxDQUFDLGFBQWE7UUFDckMsTUFBTSxFQUFFLG9CQUFNLENBQUMsSUFBSTtRQUNuQixNQUFNLEVBQUUsb0JBQU0sQ0FBQyxJQUFJO0tBQ3BCLENBQUM7SUFFYSxrQkFBTyxHQUFHLHdCQUFVLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBOEN6RCxpQkFBQztDQUFBLEFBN0RELElBNkRDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgbmV0IGZyb20gJ25ldCc7XG5cbmltcG9ydCB7IFRlbG5ldCwgcmV2ZXJzZU1hcCB9IGZyb20gJy4vZGF0YS1zdHJlYW0nO1xuXG5pbXBvcnQgeyBPYnNlcnZhYmxlIH0gZnJvbSAncnhqcy9PYnNlcnZhYmxlJztcbmltcG9ydCB7IE9ic2VydmVyIH0gZnJvbSAncnhqcy9PYnNlcnZlcic7XG5cbmNvbnN0IGNoYWxrID0gcmVxdWlyZSgnY2hhbGsnKTtcblxuLyoqXG4gKiBSYXcgVGVsbmV0IHRvIDMyNzBcbiAqXG4gKiBAc2VlIGh0dHBzOi8vdG9vbHMuaWV0Zi5vcmcvaHRtbC9yZmMxNTc2XG4gKiBAc2VlIGh0dHBzOi8vdG9vbHMuaWV0Zi5vcmcvaHRtbC9yZmMxNjQ3XG4gKiBAc2VlIGh0dHA6Ly91c2Vycy5jcy5jZi5hYy51ay9EYXZlLk1hcnNoYWxsL0ludGVybmV0L25vZGUxNDEuaHRtbFxuICovXG5cbmV4cG9ydCBjbGFzcyBUbjMyNzAge1xuXG4gIHN0cmVhbSQ6IE9ic2VydmFibGU8QnVmZmVyPjtcblxuICBwcml2YXRlIHNvY2tldDogbmV0LlNvY2tldDtcblxuICAvKiogY3RvciAqL1xuICBjb25zdHJ1Y3RvcihwdWJsaWMgaG9zdDogc3RyaW5nLFxuICAgICAgICAgICAgICBwdWJsaWMgcG9ydDogbnVtYmVyLFxuICAgICAgICAgICAgICBwdWJsaWMgbW9kZWw6IHN0cmluZykge1xuICAgIC8vIGJ1aWxkIG9ic2VydmFibGUgc3RyZWFtIG92ZXIgMzI3MCBkYXRhXG4gICAgdGhpcy5zdHJlYW0kID0gT2JzZXJ2YWJsZS5jcmVhdGUoKG9ic2VydmVyOiBPYnNlcnZlcjxCdWZmZXI+KSA9PiB7XG4gICAgICB0aGlzLnNvY2tldCA9IG5ldyBuZXQuU29ja2V0KCk7XG4gICAgICB0aGlzLnNvY2tldC5vbignZGF0YScsIChkYXRhOiBCdWZmZXIpID0+IHRoaXMuZGF0YUhhbmRsZXIoZGF0YSwgb2JzZXJ2ZXIpKTtcbiAgICAgIHRoaXMuc29ja2V0Lm9uKCdlcnJvcicsIChlcnJvcjogRXJyb3IpID0+IG9ic2VydmVyLmVycm9yKGVycm9yKSk7XG4gICAgICB0aGlzLnNvY2tldC5vbignZW5kJywgKCkgPT4gb2JzZXJ2ZXIuY29tcGxldGUoKSk7XG4gICAgICB0aGlzLnNvY2tldC5zZXROb0RlbGF5KHRydWUpO1xuICAgICAgdGhpcy5zb2NrZXQuY29ubmVjdCh7aG9zdCwgcG9ydH0sICgpID0+IHtcbiAgICAgICAgY29uc29sZS5sb2coY2hhbGsuZ3JlZW4oJzMyNzAgLT4gSE9TVCcpLCBjaGFsay5ibHVlKGBDb25uZWN0ZWQgYXQgJHtob3N0fToke3BvcnR9YCkpO1xuICAgICAgfSk7XG4gICAgICByZXR1cm4gKCkgPT4gdGhpcy5zb2NrZXQuZGVzdHJveSgpO1xuICAgIH0pO1xuICB9XG5cbiAgLyoqIFdyaXRlIHJhdyBieXRlcyB0byAzMjcwICovXG4gIHdyaXRlKGJ5dGVzOiBhbnkpOiB2b2lkIHtcbiAgICBpZiAoYnl0ZXMgaW5zdGFuY2VvZiBCdWZmZXIpXG4gICAgICB0aGlzLnNvY2tldC53cml0ZShieXRlcyk7XG4gICAgZWxzZSB0aGlzLnNvY2tldC53cml0ZShCdWZmZXIuZnJvbShieXRlcykpO1xuICB9XG5cbiAgLy8gcHJpdmF0ZSBtZXRob2RzXG5cbiAgcHJpdmF0ZSBkYXRhSGFuZGxlcihkYXRhOiBCdWZmZXIsXG4gICAgICAgICAgICAgICAgICAgICAgb2JzZXJ2ZXI6IE9ic2VydmVyPEJ1ZmZlcj4pOiB2b2lkIHtcbiAgICBpZiAoZGF0YVswXSA9PT0gVGVsbmV0LklBQykge1xuICAgICAgY29uc3QgbmVnb3RpYXRvciA9IG5ldyBOZWdvdGlhdG9yKGRhdGEpO1xuICAgICAgbGV0IHJlc3BvbnNlO1xuICAgICAgaWYgKG5lZ290aWF0b3IubWF0Y2hlcyhbJ0lBQycsICdETycsICdURVJNSU5BTF9UWVBFJ10pKVxuICAgICAgICByZXNwb25zZSA9IFsnSUFDJywgJ1dJTEwnLCAnVEVSTUlOQUxfVFlQRSddO1xuICAgICAgaWYgKG5lZ290aWF0b3IubWF0Y2hlcyhbJ0lBQycsICdETycsICdFT1InXSkpXG4gICAgICAgIHJlc3BvbnNlID0gWydJQUMnLCAnV0lMTCcsICdFT1InLCAnSUFDJywgJ0RPJywgJ0VPUiddO1xuICAgICAgaWYgKG5lZ290aWF0b3IubWF0Y2hlcyhbJ0lBQycsICdETycsICdCSU5BUlknXSkpXG4gICAgICAgIHJlc3BvbnNlID0gWydJQUMnLCAnV0lMTCcsICdCSU5BUlknLCAnSUFDJywgJ0RPJywgJ0JJTkFSWSddO1xuICAgICAgaWYgKG5lZ290aWF0b3IubWF0Y2hlcyhbJ0lBQycsICdTQicsICdURVJNSU5BTF9UWVBFJ10pKVxuICAgICAgICByZXNwb25zZSA9IFsnSUFDJywgJ1NCJywgJ1RFUk1JTkFMX1RZUEUnLCAnMHgwMCcsIHRoaXMubW9kZWwsICdJQUMnLCAnU0UnXTtcbiAgICAgIC8vIHNlbmQgcmVzcG9uc2VcbiAgICAgIGlmIChyZXNwb25zZSkge1xuICAgICAgICBjb25zb2xlLmxvZyhjaGFsay55ZWxsb3coJ0hPU1QgLT4gMzI3MCcpLCBjaGFsay53aGl0ZShuZWdvdGlhdG9yLmRlY29kZSgpKSk7XG4gICAgICAgIGNvbnNvbGUubG9nKGNoYWxrLmdyZWVuKCczMjcwIC0+IEhPU1QnKSwgY2hhbGsuZ3JheShyZXNwb25zZSkpO1xuICAgICAgICB0aGlzLndyaXRlKG5lZ290aWF0b3IuZW5jb2RlKHJlc3BvbnNlKSk7XG4gICAgICB9XG4gICAgfVxuICAgIGVsc2Ugb2JzZXJ2ZXIubmV4dChkYXRhKTtcbiAgfVxuXG59XG5cbi8qKlxuICogTmVnb3RpYXRlIFRlbG5ldCBjb25uZWN0aW9uIDMyNzAgPC0+IEhvc3RcbiAqL1xuXG5jbGFzcyBOZWdvdGlhdG9yIHtcblxuICBwcml2YXRlIHN0YXRpYyBsb29rdXAgPSB7XG4gICAgJ0JJTkFSWSc6IFRlbG5ldC5CSU5BUlksXG4gICAgJ0RPJzogVGVsbmV0LkRPLFxuICAgICdET05UJzogVGVsbmV0LkRPTlQsXG4gICAgJ0VPUic6IFRlbG5ldC5FT1IsXG4gICAgJ0lBQyc6IFRlbG5ldC5JQUMsXG4gICAgJ1NCJzogVGVsbmV0LlNCLFxuICAgICdTRSc6IFRlbG5ldC5TRSxcbiAgICAnVEVSTUlOQUxfVFlQRSc6IFRlbG5ldC5URVJNSU5BTF9UWVBFLFxuICAgICdXSUxMJzogVGVsbmV0LldJTEwsXG4gICAgJ1dPTlQnOiBUZWxuZXQuV09OVFxuICB9O1xuXG4gIHByaXZhdGUgc3RhdGljIHJldmVyc2UgPSByZXZlcnNlTWFwKE5lZ290aWF0b3IubG9va3VwKTtcblxuICAvKiogY3RvciAqL1xuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGRhdGE6IEJ1ZmZlcikgeyB9XG5cbiAgLyoqIERlY29kZSBJQUMgY29tbWFuZCAqL1xuICBkZWNvZGUoKTogc3RyaW5nW10ge1xuICAgIGNvbnN0IGNvbW1hbmRzOiBzdHJpbmdbXSA9IFtdO1xuICAgIGZvciAobGV0IGl4ID0gMDsgaXggPCB0aGlzLmRhdGEubGVuZ3RoOyBpeCsrKSB7XG4gICAgICBjb25zdCBieXRlID0gdGhpcy5kYXRhW2l4XTtcbiAgICAgIGxldCBkZWNvZGVkID0gTmVnb3RpYXRvci5yZXZlcnNlW1N0cmluZyhieXRlKV07XG4gICAgICAvLyBkZWNvZGUgYW55dGhpbmcgbm90IGluIGxvb2t1cCBhcyAweFhYXG4gICAgICBpZiAodHlwZW9mKGRlY29kZWQpID09PSAndW5kZWZpbmVkJylcbiAgICAgICAgZGVjb2RlZCA9IGAweCR7KGJ5dGUgPCAxNik/ICcwJyA6ICcnfSR7Ynl0ZS50b1N0cmluZygxNil9YDtcbiAgICAgIGNvbW1hbmRzLnB1c2goZGVjb2RlZCk7XG4gICAgfVxuICAgIHJldHVybiBjb21tYW5kcztcbiAgfVxuXG4gIC8qKiBFbmNvZGUgSUFDIHJlc3BvbnNlICovXG4gIGVuY29kZShjb21tYW5kczogc3RyaW5nW10pOiBudW1iZXJbXSB7XG4gICAgcmV0dXJuIGNvbW1hbmRzLnJlZHVjZSgoYWNjLCBjb21tYW5kKSA9PiB7XG4gICAgICBjb25zdCBlbmNvZGVkID0gTmVnb3RpYXRvci5sb29rdXBbY29tbWFuZF07XG4gICAgICAvLyBsZWF2ZSByYXcgbnVtYmVycyBhcyBpc1xuICAgICAgaWYgKHR5cGVvZihjb21tYW5kKSA9PT0gJ251bWJlcicpXG4gICAgICAgIGFjYy5wdXNoKGNvbW1hbmQpO1xuICAgICAgLy8gY29udmVydCBoZXggc3RyaW5ncyB0byBkZWNpbWFsXG4gICAgICBlbHNlIGlmIChjb21tYW5kLnN0YXJ0c1dpdGgoJzB4JykpXG4gICAgICAgIGFjYy5wdXNoKHBhcnNlSW50KGNvbW1hbmQuc3Vic3RyaW5nKDMpLCAxNikpO1xuICAgICAgLy8gYW55dGhpbmcgbm90IGluIGxvb2t1cCBpcyBhIHN0cmluZywgc28gZGVjb2RlIGJ5dGVzXG4gICAgICBlbHNlIGlmICh0eXBlb2YoZW5jb2RlZCkgPT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgIGZvciAobGV0IGl4ID0gMDsgaXggPCBjb21tYW5kLmxlbmd0aDsgaXgrKylcbiAgICAgICAgICBhY2MucHVzaChjb21tYW5kLmNoYXJDb2RlQXQoaXgpKTtcbiAgICAgIH1cbiAgICAgIGVsc2UgYWNjLnB1c2goZW5jb2RlZCk7XG4gICAgICByZXR1cm4gYWNjO1xuICAgIH0sIFtdIGFzIGFueSk7XG4gIH1cblxuICAvKiogV2hpY2ggSUFDIGNvbW1hbmQgc2VxdWVuY2U/ICovXG4gIG1hdGNoZXMoY29tbWFuZHM6IHN0cmluZ1tdKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIGNvbW1hbmRzLmV2ZXJ5KChjb21tYW5kLCBpeCkgPT4gIHtcbiAgICAgIHJldHVybiBOZWdvdGlhdG9yLmxvb2t1cFtjb21tYW5kXSA9PT0gdGhpcy5kYXRhW2l4XTtcbiAgICB9KTtcbiAgfVxuXG59XG4iXX0=