"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var net = require("net");
var Observable_1 = require("rxjs/Observable");
var chalk = require('chalk');
var Tn3270 = (function () {
    function Tn3270(host, port, model) {
        var _this = this;
        this.host = host;
        this.port = port;
        this.model = model;
        this.stream$ = Observable_1.Observable.create(function (observer) {
            _this.socket = new net.Socket();
            _this.socket.on('data', function (data) { return _this.dataHandler(data, observer); });
            _this.socket.on('error', function (error) {
                console.log(chalk.green('3270 -> HOST'), chalk.red(error.message));
                observer.error(error);
            });
            _this.socket.on('end', function () {
                console.log(chalk.green('3270 -> HOST'), chalk.cyan('Disconnected'));
                observer.complete();
            });
            _this.socket.setNoDelay(true);
            _this.socket.connect({ host: host, port: port }, function () {
                console.log(chalk.green('3270 -> HOST'), chalk.blue("Connected at " + host + ":" + port));
            });
            return function () { return _this.socket.end(); };
        });
    }
    Tn3270.prototype.write = function (bytes) {
        if (bytes instanceof Buffer)
            this.socket.write(bytes);
        else
            this.socket.write(Buffer.from(bytes));
    };
    Tn3270.prototype.dataHandler = function (data, observer) {
        if (data[0] === Telnet.IAC) {
            var negotiator = new Negotiator(data);
            var response = void 0;
            if (negotiator.matches(['IAC', 'DO', 'TERMINAL_TYPE']))
                response = ['IAC', 'WILL', 'TERMINAL_TYPE'];
            if (negotiator.matches(['IAC', 'DO', 'EOR']))
                response = ['IAC', 'WILL', 'EOR', 'IAC', 'DO', 'EOR'];
            if (negotiator.matches(['IAC', 'DO', 'BINARY']))
                response = ['IAC', 'WILL', 'BINARY', 'IAC', 'DO', 'BINARY'];
            if (negotiator.matches(['IAC', 'SB', 'TERMINAL_TYPE']))
                response = ['IAC', 'SB', 'TERMINAL_TYPE', '0x00', this.model, 'IAC', 'SE'];
            if (response) {
                console.log(chalk.yellow('HOST -> 3270'), chalk.white(negotiator.decode()));
                console.log(chalk.green('3270 -> HOST'), chalk.gray(response));
                this.write(negotiator.encode(response));
            }
        }
        else
            observer.next(data);
    };
    return Tn3270;
}());
exports.Tn3270 = Tn3270;
var Telnet;
(function (Telnet) {
    Telnet[Telnet["BINARY"] = 0] = "BINARY";
    Telnet[Telnet["DO"] = 253] = "DO";
    Telnet[Telnet["DONT"] = 254] = "DONT";
    Telnet[Telnet["EOR"] = 25] = "EOR";
    Telnet[Telnet["IAC"] = 255] = "IAC";
    Telnet[Telnet["SB"] = 250] = "SB";
    Telnet[Telnet["SE"] = 240] = "SE";
    Telnet[Telnet["TERMINAL_TYPE"] = 24] = "TERMINAL_TYPE";
    Telnet[Telnet["WILL"] = 251] = "WILL";
    Telnet[Telnet["WONT"] = 252] = "WONT";
})(Telnet || (Telnet = {}));
function reverseMap(obj) {
    return Object.keys(obj).reduce(function (acc, k) {
        acc[String(obj[k])] = k;
        return acc;
    }, {});
}
var Negotiator = (function () {
    function Negotiator(data) {
        this.data = data;
    }
    Negotiator.prototype.decode = function () {
        var commands = [];
        for (var ix = 0; ix < this.data.length; ix++) {
            var byte = this.data[ix];
            var decoded = Negotiator.reverse[String(byte)];
            if (typeof (decoded) === 'undefined')
                decoded = "0x" + ((byte < 16) ? '0' : '') + byte.toString(16);
            commands.push(decoded);
        }
        return commands;
    };
    Negotiator.prototype.encode = function (commands) {
        return commands.reduce(function (acc, command) {
            var encoded = Negotiator.lookup[command];
            if (typeof (command) === 'number')
                acc.push(command);
            else if (command.startsWith('0x'))
                acc.push(parseInt(command.substring(3), 16));
            else if (typeof (encoded) === 'undefined') {
                for (var ix = 0; ix < command.length; ix++)
                    acc.push(command.charCodeAt(ix));
            }
            else
                acc.push(encoded);
            return acc;
        }, []);
    };
    Negotiator.prototype.matches = function (commands) {
        var _this = this;
        return commands.every(function (command, ix) {
            return Negotiator.lookup[command] === _this.data[ix];
        });
    };
    Negotiator.lookup = {
        'BINARY': Telnet.BINARY,
        'DO': Telnet.DO,
        'DONT': Telnet.DONT,
        'EOR': Telnet.EOR,
        'IAC': Telnet.IAC,
        'SB': Telnet.SB,
        'SE': Telnet.SE,
        'TERMINAL_TYPE': Telnet.TERMINAL_TYPE,
        'WILL': Telnet.WILL,
        'WONT': Telnet.WONT
    };
    Negotiator.reverse = reverseMap(Negotiator.lookup);
    return Negotiator;
}());
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidG4zMjcwLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL3RuMzI3MC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLHlCQUEyQjtBQUUzQiw4Q0FBNkM7QUFHN0MsSUFBTSxLQUFLLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0FBVS9CO0lBT0UsZ0JBQW1CLElBQVksRUFDWixJQUFZLEVBQ1osS0FBYTtRQUZoQyxpQkFxQkM7UUFyQmtCLFNBQUksR0FBSixJQUFJLENBQVE7UUFDWixTQUFJLEdBQUosSUFBSSxDQUFRO1FBQ1osVUFBSyxHQUFMLEtBQUssQ0FBUTtRQUU5QixJQUFJLENBQUMsT0FBTyxHQUFHLHVCQUFVLENBQUMsTUFBTSxDQUFDLFVBQUMsUUFBMEI7WUFDMUQsS0FBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLEdBQUcsQ0FBQyxNQUFNLEVBQUUsQ0FBQztZQUMvQixLQUFJLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxNQUFNLEVBQUUsVUFBQyxJQUFZLElBQUssT0FBQSxLQUFJLENBQUMsV0FBVyxDQUFDLElBQUksRUFBRSxRQUFRLENBQUMsRUFBaEMsQ0FBZ0MsQ0FBQyxDQUFDO1lBQzNFLEtBQUksQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLE9BQU8sRUFBRSxVQUFDLEtBQVk7Z0JBQ25DLE9BQU8sQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxjQUFjLENBQUMsRUFBRSxLQUFLLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO2dCQUNuRSxRQUFRLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQ3hCLENBQUMsQ0FBQyxDQUFDO1lBQ0gsS0FBSSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsS0FBSyxFQUFFO2dCQUNwQixPQUFPLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsY0FBYyxDQUFDLEVBQUUsS0FBSyxDQUFDLElB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bSAnbmV0JztcblxuaW1wb3J0IHsgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMvT2JzZXJ2YWJsZSc7XG5pbXBvcnQgeyBPYnNlcnZlciB9IGZyb20gJ3J4anMvT2JzZXJ2ZXInO1xuXG5jb25zdCBjaGFsayA9IHJlcXVpcmUoJ2NoYWxrJyk7XG5cbi8qKlxuICogUmF3IFRlbG5ldCB0byAzMjcwXG4gKlxuICogQHNlZSBodHRwczovL3Rvb2xzLmlldGYub3JnL2h0bWwvcmZjMTU3NlxuICogQHNlZSBodHRwczovL3Rvb2xzLmlldGYub3JnL2h0bWwvcmZjMTY0N1xuICogQHNlZSBodHRwOi8vdXNlcnMuY3MuY2YuYWMudWsvRGF2ZS5NYXJzaGFsbC9JbnRlcm5ldC9ub2RlMTQxLmh0bWxcbiAqL1xuXG5leHBvcnQgY2xhc3MgVG4zMjcwIHtcblxuICBzdHJlYW0kOiBPYnNlcnZhYmxlPEJ1ZmZlcj47XG5cbiAgcHJpdmF0ZSBzb2NrZXQ6IG5ldC5Tb2NrZXQ7XG5cbiAgLyoqIGN0b3IgKi9cbiAgY29uc3RydWN0b3IocHVibGljIGhvc3Q6IHN0cmluZyxcbiAgICAgICAgICAgICAgcHVibGljIHBvcnQ6IG51bWJlcixcbiAgICAgICAgICAgICAgcHVibGljIG1vZGVsOiBzdHJpbmcpIHtcbiAgICAvLyBidWlsZCBvYnNlcnZhYmxlIHN0cmVhbSBvdmVyIDMyNzAgZGF0YVxuICAgIHRoaXMuc3RyZWFtJCA9IE9ic2VydmFibGUuY3JlYXRlKChvYnNlcnZlcjogT2JzZXJ2ZXI8QnVmZmVyPikgPT4ge1xuICAgICAgdGhpcy5zb2NrZXQgPSBuZXcgbmV0LlNvY2tldCgpO1xuICAgICAgdGhpcy5zb2NrZXQub24oJ2RhdGEnLCAoZGF0YTogQnVmZmVyKSA9PiB0aGlzLmRhdGFIYW5kbGVyKGRhdGEsIG9ic2VydmVyKSk7XG4gICAgICB0aGlzLnNvY2tldC5vbignZXJyb3InLCAoZXJyb3I6IEVycm9yKSA9PiB7XG4gICAgICAgIGNvbnNvbGUubG9nKGNoYWxrLmdyZWVuKCczMjcwIC0+IEhPU1QnKSwgY2hhbGsucmVkKGVycm9yLm1lc3NhZ2UpKTtcbiAgICAgICAgb2JzZXJ2ZXIuZXJyb3IoZXJyb3IpO1xuICAgICAgfSk7XG4gICAgICB0aGlzLnNvY2tldC5vbignZW5kJywgKCkgPT4ge1xuICAgICAgICBjb25zb2xlLmxvZyhjaGFsay5ncmVlbignMzI3MCAtPiBIT1NUJyksIGNoYWxrLmN5YW4oJ0Rpc2Nvbm5lY3RlZCcpKTtcbiAgICAgICAgb2JzZXJ2ZXIuY29tcGxldGUoKTtcbiAgICAgIH0pO1xuICAgICAgdGhpcy5zb2NrZXQuc2V0Tm9EZWxheSh0cnVlKTtcbiAgICAgIHRoaXMuc29ja2V0LmNvbm5lY3Qoe2hvc3QsIHBvcnR9LCAoKSA9PiB7XG4gICAgICAgIGNvbnNvbGUubG9nKGNoYWxrLmdyZWVuKCczMjcwIC0+IEhPU1QnKSwgY2hhbGsuYmx1ZShgQ29ubmVjdGVkIGF0ICR7aG9zdH06JHtwb3J0fWApKTtcbiAgICAgIH0pO1xuICAgICAgcmV0dXJuICgpID0+IHRoaXMuc29ja2V0LmVuZCgpO1xuICAgIH0pO1xuICB9XG5cbiAgLyoqIFdyaXRlIHJhdyBieXRlcyB0byAzMjcwICovXG4gIHdyaXRlKGJ5dGVzOiBhbnkpOiB2b2lkIHtcbiAgICBpZiAoYnl0ZXMgaW5zdGFuY2VvZiBCdWZmZXIpXG4gICAgICB0aGlzLnNvY2tldC53cml0ZShieXRlcyk7XG4gICAgZWxzZSB0aGlzLnNvY2tldC53cml0ZShCdWZmZXIuZnJvbShieXRlcykpO1xuICB9XG5cbiAgLy8gcHJpdmF0ZSBtZXRob2RzXG5cbiAgcHJpdmF0ZSBkYXRhSGFuZGxlcihkYXRhOiBCdWZmZXIsXG4gICAgICAgICAgICAgICAgICAgICAgb2JzZXJ2ZXI6IE9ic2VydmVyPEJ1ZmZlcj4pOiB2b2lkIHtcbiAgICBpZiAoZGF0YVswXSA9PT0gVGVsbmV0LklBQykge1xuICAgICAgY29uc3QgbmVnb3RpYXRvciA9IG5ldyBOZWdvdGlhdG9yKGRhdGEpO1xuICAgICAgbGV0IHJlc3BvbnNlO1xuICAgICAgaWYgKG5lZ290aWF0b3IubWF0Y2hlcyhbJ0lBQycsICdETycsICdURVJNSU5BTF9UWVBFJ10pKVxuICAgICAgICByZXNwb25zZSA9IFsnSUFDJywgJ1dJTEwnLCAnVEVSTUlOQUxfVFlQRSddO1xuICAgICAgaWYgKG5lZ290aWF0b3IubWF0Y2hlcyhbJ0lBQycsICdETycsICdFT1InXSkpXG4gICAgICAgIHJlc3BvbnNlID0gWydJQUMnLCAnV0lMTCcsICdFT1InLCAnSUFDJywgJ0RPJywgJ0VPUiddO1xuICAgICAgaWYgKG5lZ290aWF0b3IubWF0Y2hlcyhbJ0lBQycsICdETycsICdCSU5BUlknXSkpXG4gICAgICAgIHJlc3BvbnNlID0gWydJQUMnLCAnV0lMTCcsICdCSU5BUlknLCAnSUFDJywgJ0RPJywgJ0JJTkFSWSddO1xuICAgICAgaWYgKG5lZ290aWF0b3IubWF0Y2hlcyhbJ0lBQycsICdTQicsICdURVJNSU5BTF9UWVBFJ10pKVxuICAgICAgICByZXNwb25zZSA9IFsnSUFDJywgJ1NCJywgJ1RFUk1JTkFMX1RZUEUnLCAnMHgwMCcsIHRoaXMubW9kZWwsICdJQUMnLCAnU0UnXTtcbiAgICAgIC8vIHNlbmQgcmVzcG9uc2VcbiAgICAgIGlmIChyZXNwb25zZSkge1xuICAgICAgICBjb25zb2xlLmxvZyhjaGFsay55ZWxsb3coJ0hPU1QgLT4gMzI3MCcpLCBjaGFsay53aGl0ZShuZWdvdGlhdG9yLmRlY29kZSgpKSk7XG4gICAgICAgIGNvbnNvbGUubG9nKGNoYWxrLmdyZWVuKCczMjcwIC0+IEhPU1QnKSwgY2hhbGsuZ3JheShyZXNwb25zZSkpO1xuICAgICAgICB0aGlzLndyaXRlKG5lZ290aWF0b3IuZW5jb2RlKHJlc3BvbnNlKSk7XG4gICAgICB9XG4gICAgfVxuICAgIGVsc2Ugb2JzZXJ2ZXIubmV4dChkYXRhKTtcbiAgfVxuXG59XG5cbi8qKlxuICogTmVnb3RpYXRlIFRlbG5ldCBjb25uZWN0aW9uIDMyNzAgPC0+IEhvc3RcbiAqL1xuXG5lbnVtIFRlbG5ldCB7XG4gIEJJTkFSWSAgICAgICAgPSAwLFxuICBETyAgICAgICAgICAgID0gMjUzLFxuICBET05UICAgICAgICAgID0gMjU0LFxuICBFT1IgICAgICAgICAgID0gMjUsXG4gIElBQyAgICAgICAgICAgPSAyNTUsXG4gIFNCICAgICAgICAgICAgPSAyNTAsXG4gIFNFICAgICAgICAgICAgPSAyNDAsXG4gIFRFUk1JTkFMX1RZUEUgPSAyNCxcbiAgV0lMTCAgICAgICAgICA9IDI1MSxcbiAgV09OVCAgICAgICAgICA9IDI1MlxufVxuXG5mdW5jdGlvbiByZXZlcnNlTWFwKG9iajogYW55KTogYW55IHtcbiAgcmV0dXJuIE9iamVjdC5rZXlzKG9iaikucmVkdWNlKChhY2MsIGspID0+IHtcbiAgICBhY2NbU3RyaW5nKG9ialtrXSldID0gaztcbiAgICByZXR1cm4gYWNjO1xuICB9LCB7fSk7XG59XG5cbmNsYXNzIE5lZ290aWF0b3Ige1xuXG4gIHByaXZhdGUgc3RhdGljIGxvb2t1cCA9IHtcbiAgICAnQklOQVJZJzogVGVsbmV0LkJJTkFSWSxcbiAgICAnRE8nOiBUZWxuZXQuRE8sXG4gICAgJ0RPTlQnOiBUZWxuZXQuRE9OVCxcbiAgICAnRU9SJzogVGVsbmV0LkVPUixcbiAgICAnSUFDJzogVGVsbmV0LklBQyxcbiAgICAnU0InOiBUZWxuZXQuU0IsXG4gICAgJ1NFJzogVGVsbmV0LlNFLFxuICAgICdURVJNSU5BTF9UWVBFJzogVGVsbmV0LlRFUk1JTkFMX1RZUEUsXG4gICAgJ1dJTEwnOiBUZWxuZXQuV0lMTCxcbiAgICAnV09OVCc6IFRlbG5ldC5XT05UXG4gIH07XG5cbiAgcHJpdmF0ZSBzdGF0aWMgcmV2ZXJzZSA9IHJldmVyc2VNYXAoTmVnb3RpYXRvci5sb29rdXApO1xuXG4gIC8qKiBjdG9yICovXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgZGF0YTogQnVmZmVyKSB7IH1cblxuICAvKiogRGVjb2RlIElBQyBjb21tYW5kICovXG4gIGRlY29kZSgpOiBzdHJpbmdbXSB7XG4gICAgY29uc3QgY29tbWFuZHM6IHN0cmluZ1tdID0gW107XG4gICAgZm9yIChsZXQgaXggPSAwOyBpeCA8IHRoaXMuZGF0YS5sZW5ndGg7IGl4KyspIHtcbiAgICAgIGNvbnN0IGJ5dGUgPSB0aGlzLmRhdGFbaXhdO1xuICAgICAgbGV0IGRlY29kZWQgPSBOZWdvdGlhdG9yLnJldmVyc2VbU3RyaW5nKGJ5dGUpXTtcbiAgICAgIC8vIGRlY29kZSBhbnl0aGluZyBub3QgaW4gbG9va3VwIGFzIDB4WFhcbiAgICAgIGlmICh0eXBlb2YoZGVjb2RlZCkgPT09ICd1bmRlZmluZWQnKVxuICAgICAgICBkZWNvZGVkID0gYDB4JHsoYnl0ZSA8IDE2KT8gJzAnIDogJyd9JHtieXRlLnRvU3RyaW5nKDE2KX1gO1xuICAgICAgY29tbWFuZHMucHVzaChkZWNvZGVkKTtcbiAgICB9XG4gICAgcmV0dXJuIGNvbW1hbmRzO1xuICB9XG5cbiAgLyoqIEVuY29kZSBJQUMgcmVzcG9uc2UgKi9cbiAgZW5jb2RlKGNvbW1hbmRzOiBzdHJpbmdbXSk6IG51bWJlcltdIHtcbiAgICByZXR1cm4gY29tbWFuZHMucmVkdWNlKChhY2MsIGNvbW1hbmQpID0+IHtcbiAgICAgIGNvbnN0IGVuY29kZWQgPSBOZWdvdGlhdG9yLmxvb2t1cFtjb21tYW5kXTtcbiAgICAgIC8vIGxlYXZlIHJhdyBudW1iZXJzIGFzIGlzXG4gICAgICBpZiAodHlwZW9mKGNvbW1hbmQpID09PSAnbnVtYmVyJylcbiAgICAgICAgYWNjLnB1c2goY29tbWFuZCk7XG4gICAgICAvLyBjb252ZXJ0IGhleCBzdHJpbmdzIHRvIGRlY2ltYWxcbiAgICAgIGVsc2UgaWYgKGNvbW1hbmQuc3RhcnRzV2l0aCgnMHgnKSlcbiAgICAgICAgYWNjLnB1c2gocGFyc2VJbnQoY29tbWFuZC5zdWJzdHJpbmcoMyksIDE2KSk7XG4gICAgICAvLyBhbnl0aGluZyBub3QgaW4gbG9va3VwIGlzIGEgc3RyaW5nLCBzbyBkZWNvZGUgYnl0ZXNcbiAgICAgIGVsc2UgaWYgKHR5cGVvZihlbmNvZGVkKSA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgZm9yIChsZXQgaXggPSAwOyBpeCA8IGNvbW1hbmQubGVuZ3RoOyBpeCsrKVxuICAgICAgICAgIGFjYy5wdXNoKGNvbW1hbmQuY2hhckNvZGVBdChpeCkpO1xuICAgICAgfVxuICAgICAgZWxzZSBhY2MucHVzaChlbmNvZGVkKTtcbiAgICAgIHJldHVybiBhY2M7XG4gICAgfSwgW10gYXMgYW55KTtcbiAgfVxuXG4gIC8qKiBXaGljaCBJQUMgY29tbWFuZCBzZXF1ZW5jZT8gKi9cbiAgbWF0Y2hlcyhjb21tYW5kczogc3RyaW5nW10pOiBib29sZWFuIHtcbiAgICByZXR1cm4gY29tbWFuZHMuZXZlcnkoKGNvbW1hbmQsIGl4KSA9PiAge1xuICAgICAgcmV0dXJuIE5lZ290aWF0b3IubG9va3VwW2NvbW1hbmRdID09PSB0aGlzLmRhdGFbaXhdO1xuICAgIH0pO1xuICB9XG5cbn1cbiJdfQ==